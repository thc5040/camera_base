# jpeg格式

由于jpeg太重要了，这里的目标是能多清楚，就有多清楚。从字节流、最底层的方式了解jpeg

可以分为2类，一个是图像数据；另一个是非图像数据，保存了图片相关的各种信息

参考：  
https://www.cnblogs.com/P201821460033/p/13658489.html  
https://www.zhihu.com/column/c_1815784227729436673

## jpeg文件结构
从字节流的先后顺序上，一张jpeg图像都包括了哪些部分。

JPEG 文件的存储格式是以一系列“段”（segment）的形式组织的，每个段以特定的标记（marker）开始

每一段的结构如下

| 名称 | 字节数 | 数据 | 说明 |
|:---:|:-----:|:----:|:-:|
| 段标识 | 1  | 固定为0xFF | 每个新段的开始标识|
| 段类型 | 1 | 见下表 | 类型编码（称作“标记码”）|
| 段长度 | 2 | | 包括段内容和段长度本身,不包括段标识和段类型, 最大长度为0xFF FF, 64KB|
| 段内容 |   | | 最大约小于64KB|

从文件的开头到结尾依次排列大致如下，下表中每一行表示一段。

| marker | 数据标识 | 内容和作用|
|:----:|:----:|:-----:|
|SOI（Start Of Image）| 0xFF 0xD8 | 标识 JPEG 图像文件的开始，是文件的入口标记  |
|APP0 段（JFIF 标识段）| 0xFF 0xE0 | 包含 JFIF 标识符（"JFIF\0"）、版本号、像素密度信息、以及可选的缩略图数据。 JFIF 标准要求的强制段|
|其他 APPn 段|  0xFF 0xE1 到 0xFF 0xEF | 各厂商或标准自定义的数据。例如，APP1 常用于存放 EXIF（拍摄信息、GPS 信息等）。 提供附加的应用程序相关元数据，便于设备识别和后续处理。|
|DQT（Define Quantization Table）段 | 0xFF 0xDB |包含一个或多个量化表，用于对 DCT 系数进行量化处理。通常会有一个用于亮度分量，一个用于色度分量。 量化表直接影响压缩比和图像质量，是有损压缩过程中的关键参数。|
|SOF（Start Of Frame）段|0xFF 0xC0|包含图像的基本信息，如图像高度、宽度、颜色组件数、各组件的采样因子和量化表索引等。定义了图像的结构和采样方式，是后续解码的依据。|
|DHT（Define Huffman Table）段|0xFF 0xC4 |存储用于编码 DC 和 AC 系数的霍夫曼表。为图像数据的熵编码提供字典，实现数据的无损压缩。|
|SOS（Start Of Scan）段 |0xFF 0xDA |包含扫描开始时的参数，如参与本次扫描的颜色组件及其对应的霍夫曼表索引。紧跟其后的是压缩的图像数据。在图像数据中，为了防止误识别数据中的 0xFF 为标记，若 0xFF 出现时会后跟一个 0x00 字节（称为字节填充）|
|EOI（End Of Image）段|0xFF 0xD9 |标识 JPEG 文件的结束，结束整个数据流。|

## 每一段都可以拿来细讲其作用

## 举例
以某张jpeg为例，使用JPEGsnoop工具解析

| Marker | 类型标识 | 字节流offset | 长度 |
|:------:|:------:|:-----:|:-----:|
| SOI | FFD8 | 0x00 | |
| APP0 | FFE1 | 0x02 | 32245 |
| APP1 | FFE1 | 0x7DF9 | 8190 |
| APP2 | FFE2 | 0x9DF9 | 180 |
| APP7 | FFE7 | 0x9EAF | 52010 |
| APP0 | FFE0 | 0x169DB | 16 |
| DQT | FFDB | 0x169ED | 67 |
| DQT | FFDB | 0x16A32 | 67 |
| SOF0 | FFC0 | 0x16A77 | 17 |
| DHT | FFC4 | 0x16A8A | 31 |
| DHT | FFC4 | 0x16AAB | 181 |
| DHT | FFC4 | 0x16B62 | 31 |
| DHT | FFC4 | 0x16B83 | 183 |
| SOS | FFDA | 0x16C3A | 12 |
| EOI | FFD9 | 0x11D2CB6 | |

## exif元数据
用于记录照片拍摄时的各种技术参数（如曝光参数等）和环境信息（如GPS地理位置等），还有预览的缩略图。这些元数据通常以TIFF格式的结构（包括IFD、标签、数据类型和偏移量）存储在JPEG文件的APP1段中。
